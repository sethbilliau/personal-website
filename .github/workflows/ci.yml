name: CI

on:
  push:
    branches: [ main, master, project-updates ]
  pull_request:
    branches: [ main, master, project-updates ]

jobs:
  validate:
    name: Validate Website
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check file structure
        run: |
          echo "Checking required files exist..."
          test -f index.html && echo "✓ index.html exists" || (echo "✗ index.html missing" && exit 1)
          test -f styles.css && echo "✓ styles.css exists" || (echo "✗ styles.css missing" && exit 1)
          test -f script.js && echo "✓ script.js exists" || (echo "✗ script.js missing" && exit 1)

      - name: Validate JavaScript syntax
        run: |
          echo "Validating JavaScript syntax..."
          node -c script.js && echo "✓ JavaScript syntax is valid" || (echo "✗ JavaScript syntax error" && exit 1)

      - name: Check image references
        run: |
          echo "Checking for missing image files..."
          echo "Images are organized in subfolders: logos/, projects/, personal/, interests/, experience/, icons/"
          # Extract image references from HTML, handling spaces properly
          # Use a temporary approach to handle filenames with spaces
          missing=0
          # Create temp file with image paths (one per line, preserving spaces)
          # Updated to handle subdirectory structure: images/logos/, images/projects/, etc.
          grep -oP 'src="images/[^"]*"' index.html 2>/dev/null | sed 's/src="images\///' | sed 's/"$//' | sed 's/%20/ /g' | sort -u > /tmp/image_refs.txt || true
          grep -oP "url\('images/[^']*'\)" styles.css 2>/dev/null | sed "s/url('images\///" | sed "s/')$//" | sed 's/%20/ /g' | sort -u >> /tmp/image_refs.txt || true
          
          if [ ! -s /tmp/image_refs.txt ]; then
            echo "No images referenced in HTML or CSS"
          else
            while IFS= read -r img; do
              if [ -n "$img" ]; then
                # Properly quote the filename to handle spaces and check in subdirectories
                if [ ! -f "images/$img" ]; then
                  echo "✗ Missing image: images/$img"
                  missing=1
                else
                  echo "✓ Found: images/$img"
                fi
              fi
            done < /tmp/image_refs.txt
            
            if [ $missing -eq 1 ]; then
              echo "Some referenced images are missing"
              exit 1
            else
              echo "✓ All referenced images exist (including those with spaces and in subdirectories)"
            fi
            rm -f /tmp/image_refs.txt
          fi

      - name: Validate HTML
        run: |
          echo "Validating HTML..."
          npm install -g html-validator
          html-validator --file index.html --format=text || echo "HTML validation completed with warnings"
        continue-on-error: true

      - name: Validate CSS syntax
        run: |
          echo "Validating CSS syntax..."
          npm install -g css-validator
          css-validator --file styles.css || echo "CSS validation completed with warnings"
        continue-on-error: true

      - name: Check meta tags
        run: |
          echo "Checking essential meta tags..."
          grep -q 'name="viewport"' index.html && echo "✓ Viewport meta tag found" || (echo "⚠ Viewport meta tag missing (recommended)" && exit 0)
          grep -q 'name="description"' index.html && echo "✓ Description meta tag found" || (echo "⚠ Description meta tag missing (recommended)" && exit 0)
          grep -q 'rel="icon"' index.html && echo "✓ Favicon found" || (echo "⚠ Favicon missing (recommended)" && exit 0)

      - name: Check image sizes
        run: |
          echo "Checking image file sizes in all subdirectories..."
          echo "Checking: images/logos/, images/projects/, images/personal/, images/interests/, images/experience/, images/icons/"
          large_found=0
          # Check images in all subdirectories
          for subdir in images/logos images/projects images/personal images/interests images/experience images/icons; do
            if [ -d "$subdir" ]; then
              for img in "$subdir"/*.{jpg,jpeg,png,gif,svg,JPG,JPEG,PNG,GIF,SVG} 2>/dev/null; do
                if [ -f "$img" ]; then
                  size=$(stat -c%s "$img" 2>/dev/null || echo "0")
                  if [ "$size" -gt 1048576 ]; then
                    size_kb=$((size / 1024))
                    echo "⚠ Large image: $img (${size_kb}KB) - consider optimizing"
                    large_found=1
                  fi
                fi
              done
            fi
          done
          if [ $large_found -eq 0 ]; then
            echo "✓ All images are reasonably sized (<1MB)"
          fi
        continue-on-error: true

      - name: Check file sizes
        run: |
          echo "Checking main file sizes..."
          html_size=$(stat -c%s index.html 2>/dev/null || echo "0")
          css_size=$(stat -c%s styles.css 2>/dev/null || echo "0")
          js_size=$(stat -c%s script.js 2>/dev/null || echo "0")
          html_kb=$((html_size / 1024))
          css_kb=$((css_size / 1024))
          js_kb=$((js_size / 1024))
          echo "HTML: ${html_kb}KB"
          echo "CSS: ${css_kb}KB"
          echo "JS: ${js_kb}KB"
          total=$((html_size + css_size + js_size))
          if [ "$total" -gt 524288 ]; then
            echo "⚠ Total file size exceeds 512KB - consider optimization"
          else
            echo "✓ Total file size is reasonable"
          fi
        continue-on-error: true

      - name: Basic accessibility checks
        run: |
          echo "Running basic accessibility checks..."
          # Check for alt attributes on images
          images_without_alt=$(grep -c '<img[^>]*src=' index.html | grep -v 'alt=' || echo "0")
          if [ "$images_without_alt" -gt 0 ]; then
            echo "⚠ Some images may be missing alt attributes"
          else
            echo "✓ Image alt attributes check passed"
          fi
          # Check for heading hierarchy
          grep -q '<h1' index.html && echo "✓ H1 tag found" || echo "⚠ No H1 tag found"
          # Check for lang attribute
          grep -q 'lang=' index.html && echo "✓ Language attribute found" || echo "⚠ Language attribute missing"
        continue-on-error: true

      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links..."
          # Check that all anchor links point to existing sections
          anchors=$(grep -oP 'href="#[^"]*"' index.html 2>/dev/null | sed 's/href="#//' | sed 's/"//' | sort -u || true)
          sections=$(grep -oP 'id="[^"]*"' index.html 2>/dev/null | sed 's/id="//' | sed 's/"//' | sort -u || true)
          if [ -z "$anchors" ]; then
            echo "No internal links found"
          else
            broken=0
            for anchor in $anchors; do
              if [ -n "$anchor" ] && ! echo "$sections" | grep -q "^${anchor}$"; then
                echo "✗ Broken internal link: #${anchor}"
                broken=1
              fi
            done
            if [ $broken -eq 1 ]; then
              echo "Some internal links are broken"
              exit 1
            else
              echo "✓ All internal links are valid"
            fi
          fi

      - name: Basic HTML structure check
        run: |
          echo "Checking HTML structure..."
          # Check for basic HTML5 structure
          grep -q "<!DOCTYPE html>" index.html && echo "✓ DOCTYPE declaration found" || (echo "✗ Missing DOCTYPE" && exit 1)
          grep -q "<html" index.html && echo "✓ HTML tag found" || (echo "✗ Missing HTML tag" && exit 1)
          grep -q "<head" index.html && echo "✓ Head tag found" || (echo "✗ Missing head tag" && exit 1)
          grep -q "<body" index.html && echo "✓ Body tag found" || (echo "✗ Missing body tag" && exit 1)
          grep -q "<title" index.html && echo "✓ Title tag found" || (echo "✗ Missing title tag" && exit 1)

